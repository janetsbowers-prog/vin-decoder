<script>
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const previewSection = document.getElementById('previewSection');
    const previewImg = document.getElementById('previewImg');
    const loading = document.getElementById('loading');
    const resultsSection = document.getElementById('resultsSection');
    const errorMessage = document.getElementById('errorMessage');

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    });

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            uploadSection.style.display = 'none';
            previewSection.classList.add('active');
            loading.classList.add('active');
            errorMessage.classList.remove('active');
            
            processImage(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    async function processImage(imageData) {
        try {
            const response = await fetch('/api/decode-vin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: imageData })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('Server response:', result);
            
            if (result.success) {
                displayResults(result.vin, result.details);
            } else {
                throw new Error(result.error || 'Failed to decode VIN');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Failed to decode VIN: ' + error.message + '\n\nMake sure the app is deployed to Heroku!');
            loading.classList.remove('active');
        }
    }

    function displayResults(vin, details) {
        loading.classList.remove('active');
        
        document.getElementById('vinNumber').textContent = vin;
        
        const detailsGrid = document.getElementById('vehicleDetails');
        detailsGrid.innerHTML = Object.entries(details)
            .filter(([key, value]) => value && value !== 'Not Applicable')
            .map(([key, value]) => `
                <div class="info-item">
                    <div class="info-label">${key}</div>
                    <div class="info-value">${value}</div>
                </div>
            `)
            .join('');

        // If "Estimated Used Price" exists, show it separately
        if (details["Estimated Used Price"]) {
            detailsGrid.insertAdjacentHTML('beforeend', `
                <div class="price-range">
                    ðŸ’° Estimated Used Price: ${details["Estimated Used Price"]}
                </div>
            `);
        }

        resultsSection.classList.add('active');
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('active');
    }

    function reset() {
        uploadSection.style.display = 'block';
        previewSection.classList.remove('active');
        resultsSection.classList.remove('active');
        errorMessage.classList.remove('active');
        fileInput.value = '';
    }
</script>
