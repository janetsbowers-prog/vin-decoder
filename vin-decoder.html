<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Yanni Pricing ‚Äì VIN Decoder</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --italian-red: #b71c1c;
  --italian-green: #1b7d2b;
  --italian-gold: #f39c12;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(145deg,#f8fafc,#f0f4f8);
  color:#333;
  margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh;
}

/* --- TITLE --- */
#appTitle{font-family:'Cinzel Decorative',cursive;text-align:center;margin-top:25px;line-height:1.1;position:relative;}
#appTitle::after{content:"";display:block;height:6px;width:80px;margin:8px auto 0 auto;border-radius:4px;
 background:linear-gradient(90deg,var(--italian-green),white,var(--italian-red));}
.brand-line{display:inline-block;background:linear-gradient(135deg,var(--italian-red),var(--italian-gold));
 -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
@media(min-width:600px){.brand-line{font-size:3rem}}
@media(max-width:599px){.brand-line{font-size:2.1rem}}
#appSubtitle{text-align:center;font-size:1.1rem;color:#555;font-style:italic;margin-bottom:20px;}

/* --- PANELS --- */
.panel{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);
 padding:20px 30px;width:90%;max-width:700px;margin-top:25px;}
#fileInput,#carFileInput{display:none;}

/* CUSTOM BUTTONS */
.upload-btn{display:inline-block;background-color:var(--italian-red);color:#fff;font-size:1.05rem;
 padding:12px 22px;border-radius:6px;cursor:pointer;font-weight:600;}
.upload-btn:hover{background-color:#8e1515;}
.secondary-btn{background-color:var(--italian-green);border:none;color:white;padding:10px 18px;
 font-size:1em;border-radius:5px;cursor:pointer;margin:10px 5px;}
.secondary-btn:hover{background-color:#15691f;}
.delete-btn{background:none;border:none;color:#b91c1c;font-size:1.2rem;font-weight:bold;cursor:pointer;margin-left:auto;}
.delete-btn:hover{color:#dc2626;}

/* RESULTS */
#previewImg,#carImgPreview{max-width:100%;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15);
margin-bottom:12px;max-height:280px;object-fit:cover;}
#vinNumber{font-weight:700;font-size:1.2em;color:var(--italian-red);text-align:center;margin-bottom:10px;}
.info-item{background:#f9fafb;border-radius:6px;padding:10px 15px;margin:5px 8px;display:inline-block;}
.price-range{background:#d1fae5;padding:8px;border-radius:6px;text-align:center;font-weight:600;color:#065f46;}
#errorMessage{display:none;background:#fee2e2;color:#b91c1c;border-radius:6px;padding:15px 20px;margin-top:20px;}
#errorMessage.active{display:block;}

/* HISTORY */
#historyList{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.history-item{display:flex;align-items:center;background:#f9fafb;border-left:4px solid var(--italian-red);
border-radius:6px;padding:10px 15px;gap:10px;}
.history-thumb{width:60px;height:45px;border-radius:4px;object-fit:cover;}
.history-text{flex:1;}
.history-vin{font-weight:700;}
.history-meta{font-size:.9em;color:#6b7280;}

/* LOADING SPINNER */
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--italian-red);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#loadingSpinner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.95);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
</head>
<body>

<h1 id="appTitle"><span class="brand-line">Yanni</span><br><span class="brand-line">Pricing</span></h1>
<div id="appSubtitle">Decodifica del VIN e prezzi stimati dei veicoli</div>

<!-- 1Ô∏è‚É£ Upload VIN -->
<div id="uploadSection" class="panel" style="text-align:center;">
  <p>üì∏ Upload a VIN picture (file or camera):</p>
  <label class="upload-btn">Upload VIN Image
    <input type="file" id="fileInput" accept="image/*">
  </label>
</div>

<!-- 2Ô∏è‚É£ Result -->
<div id="resultsSection" class="panel" style="display:none;">
  <img id="previewImg" alt="VIN preview">
  <div id="vinNumber"></div>
  <div id="vehicleDetails"></div>

  <!-- Car prompt -->
  <div id="carOption" style="text-align:center;display:none;margin-top:15px;">
    <p>Do you want to add a photo of this car?</p>
    <button id="carYesBtn" class="secondary-btn">Yes</button>
    <button id="carNoBtn" class="secondary-btn">No</button>
  </div>

  <!-- Car upload -->
  <div id="carUpload" style="display:none;text-align:center;">
    <label class="secondary-btn">üöó Upload Car Photo
      <input type="file" id="carFileInput" accept="image/*">
    </label>
    <img id="carImgPreview" style="display:none;" alt="Car preview">
  </div>

  <!-- Add to History prompt -->
  <div id="historyPrompt" style="text-align:center;display:none;margin-top:15px;">
    <p>Add this scan to your history?</p>
    <button id="saveYesBtn" class="secondary-btn">Yes, Save It</button>
    <button id="saveNoBtn" class="secondary-btn">No, Skip It</button>
  </div>

  <button id="scanAnotherBtn" class="secondary-btn" style="display:none;">üîÅ Scan another VIN</button>
</div>

<!-- ERROR -->
<div id="errorMessage"></div>

<!-- LOADING SPINNER -->
<div id="loadingSpinner" style="display:none;">
  <div style="text-align:center;padding:40px;">
    <div class="spinner"></div>
    <p style="margin-top:20px;color:#666;font-size:1.1rem;">üîç Decoding VIN and searching databases...</p>
  </div>
</div>

<!-- 3Ô∏è‚É£ History -->
<div id="historySection" class="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h2 style="margin:0;">üìú Scan History</h2>
    <button id="deleteAllBtn" class="secondary-btn" style="background-color:#b91c1c;margin:0;">üóëÔ∏è Delete All History</button>
  </div>
  <div id="historyList">No previous scans yet.</div>
</div>

<script>
let currentVIN=null;
let currentDetails=null;
let currentCarImg=null;

const uploadSection=document.getElementById('uploadSection');
const fileInput=document.getElementById('fileInput');
const carFileInput=document.getElementById('carFileInput');
const previewImg=document.getElementById('previewImg');
const carImgPreview=document.getElementById('carImgPreview');
const resultsSection=document.getElementById('resultsSection');
const vinNumber=document.getElementById('vinNumber');
const vehicleDetails=document.getElementById('vehicleDetails');
const carOption=document.getElementById('carOption');
const carUpload=document.getElementById('carUpload');
const historyPrompt=document.getElementById('historyPrompt');
const scanAnotherBtn=document.getElementById('scanAnotherBtn');
const historyList=document.getElementById('historyList');
const errorMessage=document.getElementById('errorMessage');
const loadingSpinner=document.getElementById('loadingSpinner');

/* UPLOAD VIN */
fileInput.addEventListener('change',e=>{
  const file=e.target.files[0];
  if(file)readVINImage(file);
});

/* CAR OPTION BUTTONS */
document.getElementById('carYesBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  showCarUpload(true);
});

document.getElementById('carNoBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  showCarUpload(false);
});

document.getElementById('scanAnotherBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  reset();
});

function readVINImage(file){
  const r=new FileReader();
  r.onload=e=>{
    const imgData=e.target.result;
    previewImg.src=imgData;
    previewImg.style.display="block";
    decodeVIN(imgData);
  };
  r.readAsDataURL(file);
}

/* SIMULATE / CALL ACTUAL API */
async function decodeVIN(imgData){
  loadingSpinner.style.display='flex'; // Show spinner
  try {
    const res = await fetch('/api/decode-vin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imgData })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `Server error: ${res.status}`);
    }

    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed to decode VIN');

    loadingSpinner.style.display='none'; // Hide spinner
    handleDecoded(data.vin, data.details);
  } catch (err) {
    loadingSpinner.style.display='none'; // Hide spinner on error
    showError('Failed to decode VIN: ' + err.message);
  }
}

/* AFTER DECODE */
function handleDecoded(vin,details){
  currentVIN=vin;
  currentDetails=details;
  currentCarImg=null;

  // Clear any previous errors
  errorMessage.classList.remove('active');

  // Check for existing VIN
  const history=getHistory();
  const existingIdx=history.findIndex(h=>h.vin===vin);
  if(existingIdx>-1){
    if(!confirm('VIN already exists in history. Replace it?')){reset();return;}
    history.splice(existingIdx,1);
    saveHistory(history);
  }

  // Display results
  uploadSection.style.display='none';
  resultsSection.style.display='block';
  vinNumber.textContent=vin;

  // Prioritize Make & Model first
  const orderedFields = ['Make', 'Model'];
  let html = '';
  
  // Add Make & Model first if they exist
  orderedFields.forEach(field => {
    if(details[field]) {
      html += `<div class="info-item"><strong>${field}: </strong>${details[field]}</div>`;
    }
  });
  
  // Add remaining fields
  Object.entries(details).forEach(([k,v]) => {
    if(!orderedFields.includes(k)) {
      html += `<div class="info-item"><strong>${k}: </strong>${v}</div>`;
    }
  });
  
  vehicleDetails.innerHTML = html;

  carOption.style.display='block';
  scanAnotherBtn.style.display='none';
}

/* ASK about car */
function showCarUpload(wants){
  carOption.style.display='none';
  if(wants){
    carUpload.style.display='block';
  }else{
    // No car photo, so set it and show history prompt
    currentCarImg='No pic given';
    historyPrompt.style.display='block';
  }
}

carFileInput.addEventListener('change',e=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=f=>{
      currentCarImg=f.target.result;
      carImgPreview.src=currentCarImg;
      carImgPreview.style.display='block';
      // Hide the upload button, show history prompt
      carUpload.querySelector('.secondary-btn').style.display='none';
      historyPrompt.style.display='block';
    };
    reader.readAsDataURL(file);
  }
});

/* HISTORY PROMPT BUTTONS */
document.getElementById('saveYesBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  saveToHistory(true);
});

document.getElementById('saveNoBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  saveToHistory(false);
});

/* SAVE TO HISTORY */
function saveToHistory(shouldSave){
  historyPrompt.style.display='none';
  
  console.log('saveToHistory called with:', shouldSave);
  console.log('currentVIN:', currentVIN);
  console.log('currentDetails:', currentDetails);
  console.log('currentCarImg:', currentCarImg ? 'present' : 'missing');
  
  if(shouldSave){
    saveEntry(currentVIN, currentDetails, currentCarImg);
    console.log('Entry saved to history');
  }
  
  scanAnotherBtn.style.display='inline-block';
}

/* HISTORY FUNCTIONS */
function getHistory(){
  return JSON.parse(localStorage.getItem('vinHistory')||'[]');
}
function saveHistory(arr){
  localStorage.setItem('vinHistory',JSON.stringify(arr));
}
function saveEntry(vin,details,carImg){
  console.log('saveEntry called with VIN:', vin);
  const h=getHistory();
  console.log('Current history length:', h.length);
  h.unshift({vin,details,carImg, timestamp:new Date().toLocaleString()});
  saveHistory(h);
  console.log('New history length:', h.length);
  renderHistory();
}
function renderHistory(){
  const h=getHistory();
  if(!h.length)return historyList.innerHTML='No previous scans yet.';
  historyList.innerHTML=h.map((item,i)=>`
    <div class="history-item" onclick="loadHistory(${i})">
      ${item.carImg && item.carImg!=='No pic given'
        ? `<img src="${item.carImg}" class="history-thumb">`
        : `<div style='width:60px;text-align:center;font-size:0.8em;color:#777;'>No pic given</div>`}
      <div class="history-text">
        <div class="history-vin">${item.vin}</div>
        <div class="history-meta">${item.details.Make||'Unknown'} ‚Äì ${item.details.Model||'Unknown'} (${item.timestamp})</div>
      </div>
      <button class="delete-btn" onclick="deleteHistory(${i});event.stopPropagation();">√ó</button>
    </div>`).join('');
}
function loadHistory(i){
  const h=getHistory();
  const item=h[i]; if(!item)return;
  uploadSection.style.display='none';
  resultsSection.style.display='block';
  
  // Hide VIN preview since we don't store it in history
  previewImg.style.display='none';
  
  vinNumber.textContent=item.vin;
  
  // Prioritize Make & Model first (same as handleDecoded)
  const orderedFields = ['Make', 'Model'];
  let html = '';
  
  orderedFields.forEach(field => {
    if(item.details[field]) {
      html += `<div class="info-item"><strong>${field}: </strong>${item.details[field]}</div>`;
    }
  });
  
  Object.entries(item.details).forEach(([k,v]) => {
    if(!orderedFields.includes(k)) {
      html += `<div class="info-item"><strong>${k}: </strong>${v}</div>`;
    }
  });
  
  vehicleDetails.innerHTML = html;
  
  if(item.carImg && item.carImg!=='No pic given'){
    carUpload.style.display='block';
    carImgPreview.src=item.carImg;
    carImgPreview.style.display='block';
  }else{
    carUpload.style.display='none';
    carImgPreview.style.display='none';
  }
  carOption.style.display='none';
  scanAnotherBtn.style.display='inline-block';
}
function deleteHistory(i){
  const h=getHistory(); 
  h.splice(i,1); 
  saveHistory(h); 
  renderHistory();
}

function deleteAllHistory(){
  saveHistory([]);
  renderHistory();
}

/* UTIL */
function showError(msg){
  errorMessage.textContent='Error: '+msg;
  errorMessage.classList.add('active');
}
function reset(){
  uploadSection.style.display='block';
  resultsSection.style.display='none';
  carOption.style.display='none';
  carUpload.style.display='none';
  carImgPreview.style.display='none';
  historyPrompt.style.display='none';
  scanAnotherBtn.style.display='none';
  errorMessage.classList.remove('active');
  fileInput.value=''; carFileInput.value='';
  currentVIN=null; currentDetails=null; currentCarImg=null;
}

document.getElementById('deleteAllBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  deleteAllHistory();
});

renderHistory();
</script>
</body>
</html>
