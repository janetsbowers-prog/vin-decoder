<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Yanniâ€¯Pricingâ€¯â€“â€¯VINâ€¯Decoder</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --italian-red:#b71c1c;
  --italian-green:#1b7d2b;
  --italian-gold:#f39c12;
}

/* ----- Layout ----- */
body {font-family:'Inter',sans-serif;background:linear-gradient(145deg,#f8fafc,#f0f4f8);
  color:#333;margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh;}

/* ----- Title ----- */
#appTitle{font-family:'Cinzel Decorative',cursive;text-align:center;margin-top:25px;line-height:1.1;position:relative;}
#appTitle::after{content:"";display:block;height:6px;width:80px;margin:8px auto 0 auto;border-radius:4px;
  background:linear-gradient(90deg,var(--italian-green),white,var(--italian-red));}
.brand-line{display:inline-block;background:linear-gradient(135deg,var(--italian-red),var(--italian-gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
@media(min-width:600px){.brand-line{font-size:3rem}}@media(max-width:599px){.brand-line{font-size:2.1rem}}
#appSubtitle{text-align:center;font-size:1.1rem;color:#555;margin-bottom:20px;font-style:italic;}

/* ----- Panels ----- */
.panel{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);
  padding:20px 30px;width:90%;max-width:700px;margin-top:25px;}

#fileInput,#carFileInput{display:none;}

/* Upload button */
#customUpload{display:inline-block;background-color:var(--italian-red);color:#fff;font-size:1.05rem;
  padding:12px 22px;border-radius:6px;cursor:pointer;transition:background-color .25s,transform .15s;
  font-weight:600;}
#customUpload:hover{background-color:#8e1515;transform:translateY(-1px);}

/* Previews */
#previewSection{display:none;flex-direction:column;align-items:center;}
#previewSection.active{display:flex;}
#previewImg,#carPreviewImg{max-width:100%;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);
  margin-bottom:12px;max-height:300px;object-fit:cover;}
#loading{font-weight:bold;color:var(--italian-red);display:none;}
#loading.active{display:block;}

/* Buttons */
button{margin-top:15px;border:none;color:white;padding:10px 18px;font-size:1em;border-radius:5px;
  cursor:pointer;transition:background-color .2s;}
.primary-btn{background-color:var(--italian-red);}
.primary-btn:hover{background-color:#8e1515;}
.secondary-btn{background-color:var(--italian-green);}
.secondary-btn:hover{background-color:#15691f;}
.delete-btn{background:none;border:none;color:#b91c1c;font-size:1.1rem;font-weight:bold;cursor:pointer;margin-left:auto;}
.delete-btn:hover{color:#dc2626;}

/* Results */
#vinNumber{font-weight:700;font-size:1.2em;color:var(--italian-red);text-align:center;margin-bottom:10px;}
#vehicleDetails{display:flex;flex-wrap:wrap;gap:10px;}
.info-item{background:#f9fafb;border-radius:6px;padding:10px 15px;min-width:200px;border-left:4px solid var(--italian-red);}
.info-label{font-weight:600;}
.price-range{margin-top:15px;font-weight:700;font-size:1.05em;color:#065f46;background:#d1fae5;
  padding:10px;border-radius:6px;width:100%;text-align:center;}
#errorMessage{display:none;margin-top:20px;background:#fee2e2;padding:15px 20px;border-radius:6px;
  color:#b91c1c;white-space:pre-line;}
#errorMessage.active{display:block;}

/* History */
#historyList{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.history-item{cursor:pointer;padding:10px 15px;border-radius:6px;background:#f9fafb;
  border-left:4px solid var(--italian-red);display:flex;align-items:center;gap:10px;}
.history-thumb{width:60px;height:45px;border-radius:4px;object-fit:cover;}
.history-text{flex:1;display:flex;flex-direction:column;}
.history-vin{font-weight:700;}
.history-meta{font-size:.9em;color:#6b7280;}
</style>
</head>
<body>

<h1 id="appTitle"><span class="brand-line">Yanni</span><br><span class="brand-line">Pricing</span></h1>
<div id="appSubtitle">Decodificaâ€¯delÂ VINâ€¯eâ€¯prezziâ€¯stimatiâ€¯deiâ€¯veicoli</div>

<!-- Upload VIN -->
<div id="uploadSection" class="panel">
  <p>Upload an image containing a Vehicle Identification NumberÂ (VIN):</p>
  <label id="customUpload">ğŸ“¸Â UploadÂ VINÂ image<input type="file" id="fileInput" accept="image/*"></label>
</div>

<!-- Preview -->
<div id="previewSection" class="panel">
  <img id="previewImg" alt="VIN preview">
  <div id="loading">Processing VIN...Â â³</div>
</div>

<!-- Results -->
<div id="resultsSection" class="panel">
  <div id="vinNumber"></div>
  <div id="vehicleDetails"></div>
  <div id="carUploadPrompt" style="display:none;text-align:center;margin-top:20px;">
    <p>Would you like to add a photo of this car?</p>
    <label id="customCarUpload" class="secondary-btn" style="padding:8px 16px;">
      ğŸš—â€¯UploadÂ carÂ photo
      <input type="file" id="carFileInput" accept="image/*">
    </label>
  </div>
<button id="decodeAnotherBtn" class="secondary-btn" style="display:none;" onclick="reset()">ğŸ”Â DecodeÂ anotherÂ VIN</button></div>

<!-- Error -->
<div id="errorMessage"></div>

<!-- History -->
<div id="historySection" class="panel">
  <h2>ğŸ“œÂ ScanÂ History</h2>
  <div id="historyList">No previous scans yet.</div>
</div>

<script>
const fileInput=document.getElementById('fileInput');
const carFileInput=document.getElementById('carFileInput');
const uploadSection=document.getElementById('uploadSection');
const previewSection=document.getElementById('previewSection');
const previewImg=document.getElementById('previewImg');
const loading=document.getElementById('loading');
const resultsSection=document.getElementById('resultsSection');
const errorMessage=document.getElementById('errorMessage');
const historyList=document.getElementById('historyList');
const decodeAnotherBtn=document.getElementById('decodeAnotherBtn');
const carUploadPrompt=document.getElementById('carUploadPrompt');
let currentVIN=null;

/* ---------- Image handling ---------- */
fileInput.addEventListener('change',e=>{
  const file=e.target.files[0];
  if(file)handleFile(file);
});
carFileInput.addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file||!currentVIN)return;
  const reader=new FileReader();
  reader.onload=()=>{
    updateHistoryCarPhoto(currentVIN,reader.result);
    renderHistory();
    alert('Car photo added to '+currentVIN+' in history.');
  };
  reader.readAsDataURL(file);
});

function handleFile(file){
  const reader=new FileReader();
  reader.onload=async e=>{
    const data=e.target.result;
    previewImg.src=data;
    uploadSection.style.display='none';
    previewSection.classList.add('active');
    loading.classList.add('active');
    errorMessage.classList.remove('active');
    const resized=await resizeImageIfNeeded(data);
    processImage(resized);
  };
  reader.readAsDataURL(file);
}

const MAX_IMAGE_BYTES=4.5*1024*1024;
function resizeImageIfNeeded(dataUrl,maxBytes=MAX_IMAGE_BYTES){
  return new Promise(resolve=>{
    const est=Math.ceil((dataUrl.length*3)/4);
    if(est<=maxBytes)return resolve(dataUrl);
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      const scale=Math.sqrt(maxBytes/est);
      canvas.width=img.width*scale;
      canvas.height=img.height*scale;
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      resolve(canvas.toDataURL('image/jpeg',0.7));
    };
    img.onerror=()=>resolve(dataUrl); img.src=dataUrl;
  });
}

async function processImage(imageData){
  try{
    const response=await fetch('/api/decode-vin',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({image:imageData})
    });
    if(!response.ok){
      const err=await response.json(); throw new Error(err.error||`Server error: ${response.status}`);
    }
    const result=await response.json();
    if(result.success){
      displayResults(result.vin,result.details);
      saveToHistory(result.vin,result.details);
    }else throw new Error(result.error||'Failed to decode VIN');
  }catch(err){
    showError('Failed to decode VIN: '+err.message);
    loading.classList.remove('active');
  }
}

/* ---------- Display / History ---------- */
function displayResults(vin,details){
  currentVIN=vin;
  loading.classList.remove('active');
  document.getElementById('vinNumber').textContent=vin;
  const grid=document.getElementById('vehicleDetails');
  grid.innerHTML=Object.entries(details)
   .filter(([k,v])=>v&&v!=='Not Applicable')
   .map(([k,v])=>`
     <div class="info-item">
       <div class="info-label">${k}</div>
       <div class="info-value">${v}</div>
     </div>`).join('');
  if(details["Estimated Used Price"])
    grid.insertAdjacentHTML('beforeend',
      `<div class="price-range">ğŸ’°Â Estimatedâ€¯UsedÂ Price:Â ${details["Estimated Used Price"]}</div>`);
  resultsSection.classList.add('active');
  decodeAnotherBtn.style.display='inline-block';
  carUploadPrompt.style.display='block';
}

function saveToHistory(vin,details){
  let history=JSON.parse(localStorage.getItem('vinHistory')||'[]');
  const existingIndex=history.findIndex(i=>i.vin===vin);
  if(existingIndex>-1){
    const replace=confirm(`VIN ${vin} already exists in history.\nDo you want to replace it?`);
    if(replace) history.splice(existingIndex,1); else return;
  }
  history.unshift({vin,details,timestamp:new Date().toLocaleString()});
  localStorage.setItem('vinHistory',JSON.stringify(history));
  renderHistory();
}

function updateHistoryCarPhoto(vin,photo){
  let h=JSON.parse(localStorage.getItem('vinHistory')||'[]');
  const item=h.find(i=>i.vin===vin);
  if(item){item.carImg=photo;localStorage.setItem('vinHistory',JSON.stringify(h));}
}

function renderHistory(){
  const history=JSON.parse(localStorage.getItem('vinHistory')||'[]');
  if(!history.length){historyList.innerHTML='No previous scans yet.';return;}
  historyList.innerHTML=history.map((item,i)=>`
    <div class="history-item" data-index="${i}">
      ${item.carImg?`<img src="${item.carImg}" alt="car" class="history-thumb">`:''}
      <div class="history-text">
        <div class="history-vin">${item.vin}</div>
        <div class="history-meta">${item.details.Make||'Unknown'}Â â€“Â ${item.details.Model||'Unknown'}Â (${item.timestamp})</div>
      </div>
      <button class="delete-btn" onclick="deleteHistory(${i});event.stopPropagation();">Ã—</button>
    </div>`).join('');
}

function loadFromHistory(i){
  const h=JSON.parse(localStorage.getItem('vinHistory')||'[]');
  const item=h[i]; if(!item)return;
  reset(false);
  displayResults(item.vin,item.details);
  if(item.carImg) updateHistoryCarPhoto(item.vin,item.carImg);
}

function deleteHistory(i){
  if(!confirm('Delete this entry from history?'))return;
  const h=JSON.parse(localStorage.getItem('vinHistory')||'[]');
  h.splice(i,1);
  localStorage.setItem('vinHistory',JSON.stringify(h));
  renderHistory();
}

function showError(msg){
  errorMessage.textContent=msg;
  errorMessage.classList.add('active');
}

function reset(clearPreview=true){
  uploadSection.style.display='block';
  previewSection.classList.remove('active');
  resultsSection.classList.remove('active');
  errorMessage.classList.remove('active');
  decodeAnotherBtn.style.display='none';
  carUploadPrompt.style.display='none';
  if(clearPreview){fileInput.value='';currentVIN=null;}
}

renderHistory();
</script>
</body>
</html>
